#include "wmath.hpp"

#include <dlib/matrix.h>

using dlib::abs;
using dlib::cholesky_decomposition;
using dlib::diag;
using dlib::diagm;
using dlib::dot;
using dlib::eigenvalue_decomposition;
using dlib::identity_matrix;
using dlib::inv;
using dlib::length;
using dlib::length_squared;
using dlib::make_symmetric;
using dlib::matrix;
using dlib::matrix_exp;
using dlib::matrix_op;
using dlib::normalize;
using dlib::op_make_symmetric;
using dlib::round;
using dlib::set_colm;
using dlib::tmp;
using dlib::trace;
using dlib::zeros_matrix;
using std::abs;
using std::array;
using std::cerr;
using std::cin;
using std::cout;
using std::endl;
using std::fill;
using std::fixed;
using std::floor;
using std::get;
using std::getline;
using std::ifstream;
using std::isnan;
using std::istream;
using std::lower_bound;
using std::map;
using std::max_element;
using std::numeric_limits;
using std::ofstream;
using std::pow;
using std::round;
using std::setprecision;
using std::setw;
using std::sort;
using std::stod;
using std::streamsize;
using std::string;
using std::stringstream;
using std::swap;
using std::tuple;
using std::unordered_map;
using std::vector;
using wmath::long_mul;
using wmath::clz;
using wmath::digits;

// for i: 0 while i < 1024 do print(float(inverse_erf((i+1/2)/1024)));
double inverse_cdf_lut[] = {
0.000432728017954,
0.001298184702101,
0.002163643330973,
0.003029105201077,
0.003894571608953,
0.004760043851189,
0.005625523224434,
0.006491011025411,
0.007356508550934,
0.008222017097915,
0.009087537963385,
0.009953072444504,
0.010818621838572,
0.011684187443048,
0.012549770555560,
0.013415372473921,
0.014280994496139,
0.015146637920436,
0.016012304045255,
0.016877994169280,
0.017743709591446,
0.018609451610953,
0.019475221527282,
0.020341020640206,
0.021206850249802,
0.022072711656472,
0.022938606160948,
0.023804535064312,
0.024670499668007,
0.025536501273850,
0.026402541184049,
0.027268620701212,
0.028134741128366,
0.029000903768966,
0.029867109926913,
0.030733360906564,
0.031599658012748,
0.032466002550781,
0.033332395826475,
0.034198839146159,
0.035065333816685,
0.035931881145449,
0.036798482440400,
0.037665139010056,
0.038531852163519,
0.039398623210484,
0.040265453461259,
0.041132344226777,
0.041999296818608,
0.042866312548974,
0.043733392730765,
0.044600538677551,
0.045467751703595,
0.046335033123871,
0.047202384254073,
0.048069806410636,
0.048937300910741,
0.049804869072337,
0.050672512214153,
0.051540231655709,
0.052408028717336,
0.053275904720183,
0.054143860986239,
0.055011898838341,
0.055880019600192,
0.056748224596375,
0.057616515152365,
0.058484892594545,
0.059353358250223,
0.060221913447640,
0.061090559515991,
0.061959297785436,
0.062828129587116,
0.063697056253166,
0.064566079116729,
0.065435199511976,
0.066304418774112,
0.067173738239400,
0.068043159245168,
0.068912683129827,
0.069782311232885,
0.070652044894966,
0.071521885457816,
0.072391834264325,
0.073261892658542,
0.074132061985684,
0.075002343592158,
0.075872738825569,
0.076743249034742,
0.077613875569732,
0.078484619781840,
0.079355483023632,
0.080226466648947,
0.081097572012918,
0.081968800471986,
0.082840153383915,
0.083711632107804,
0.084583238004108,
0.085454972434650,
0.086326836762637,
0.087198832352676,
0.088070960570787,
0.088943222784422,
0.089815620362480,
0.090688154675319,
0.091560827094777,
0.092433638994183,
0.093306591748376,
0.094179686733720,
0.095052925328116,
0.095926308911026,
0.096799838863480,
0.097673516568099,
0.098547343409105,
0.099421320772343,
0.100295450045292,
0.101169732617086,
0.102044169878524,
0.102918763222092,
0.103793514041976,
0.104668423734081,
0.105543493696043,
0.106418725327250,
0.107294120028856,
0.108169679203799,
0.109045404256816,
0.109921296594459,
0.110797357625116,
0.111673588759021,
0.112549991408279,
0.113426566986875,
0.114303316910694,
0.115180242597542,
0.116057345467156,
0.116934626941224,
0.117812088443405,
0.118689731399342,
0.119567557236681,
0.120445567385088,
0.121323763276268,
0.122202146343978,
0.123080718024051,
0.123959479754407,
0.124838432975075,
0.125717579128210,
0.126596919658107,
0.127476456011225,
0.128356189636201,
0.129236121983866,
0.130116254507268,
0.130996588661687,
0.131877125904653,
0.132757867695966,
0.133638815497712,
0.134519970774283,
0.135401334992394,
0.136282909621103,
0.137164696131828,
0.138046695998367,
0.138928910696917,
0.139811341706089,
0.140693990506933,
0.141576858582950,
0.142459947420117,
0.143343258506902,
0.144226793334286,
0.145110553395778,
0.145994540187440,
0.146878755207902,
0.147763199958383,
0.148647875942709,
0.149532784667336,
0.150417927641366,
0.151303306376569,
0.152188922387400,
0.153074777191024,
0.153960872307332,
0.154847209258959,
0.155733789571312,
0.156620614772581,
0.157507686393766,
0.158395005968695,
0.159282575034044,
0.160170395129358,
0.161058467797073,
0.161946794582533,
0.162835377034016,
0.163724216702753,
0.164613315142944,
0.165502673911789,
0.166392294569501,
0.167282178679329,
0.168172327807583,
0.169062743523651,
0.169953427400025,
0.170844381012317,
0.171735605939287,
0.172627103762860,
0.173518876068152,
0.174410924443488,
0.175303250480429,
0.176195855773788,
0.177088741921659,
0.177981910525435,
0.178875363189833,
0.179769101522917,
0.180663127136116,
0.181557441644254,
0.182452046665568,
0.183346943821735,
0.184242134737891,
0.185137621042658,
0.186033404368164,
0.186929486350070,
0.187825868627593,
0.188722552843528,
0.189619540644274,
0.190516833679856,
0.191414433603952,
0.192312342073915,
0.193210560750798,
0.194109091299379,
0.195007935388184,
0.195907094689516,
0.196806570879475,
0.197706365637985,
0.198606480648821,
0.199506917599631,
0.200407678181964,
0.201308764091295,
0.202210177027048,
0.203111918692627,
0.204013990795437,
0.204916395046915,
0.205819133162549,
0.206722206861914,
0.207625617868688,
0.208529367910689,
0.209433458719893,
0.210337892032466,
0.211242669588790,
0.212147793133488,
0.213053264415457,
0.213959085187889,
0.214865257208301,
0.215771782238564,
0.216678662044932,
0.217585898398065,
0.218493493073062,
0.219401447849488,
0.220309764511402,
0.221218444847388,
0.222127490650578,
0.223036903718689,
0.223946685854045,
0.224856838863613,
0.225767364559025,
0.226678264756616,
0.227589541277447,
0.228501195947336,
0.229413230596894,
0.230325647061548,
0.231238447181574,
0.232151632802132,
0.233065205773288,
0.233979167950055,
0.234893521192416,
0.235808267365361,
0.236723408338913,
0.237638945988167,
0.238554882193315,
0.239471218839683,
0.240387957817760,
0.241305101023232,
0.242222650357016,
0.243140607725290,
0.244058975039526,
0.244977754216529,
0.245896947178461,
0.246816555852884,
0.247736582172786,
0.248657028076622,
0.249577895508343,
0.250499186417431,
0.251420902758938,
0.252343046493515,
0.253265619587452,
0.254188624012710,
0.255112061746958,
0.256035934773607,
0.256960245081849,
0.257884994666691,
0.258810185528990,
0.259735819675494,
0.260661899118873,
0.261588425877761,
0.262515401976792,
0.263442829446634,
0.264370710324032,
0.265299046651842,
0.266227840479072,
0.267157093860917,
0.268086808858800,
0.269016987540413,
0.269947631979750,
0.270878744257153,
0.271810326459346,
0.272742380679480,
0.273674909017169,
0.274607913578531,
0.275541396476233,
0.276475359829526,
0.277409805764288,
0.278344736413068,
0.279280153915123,
0.280216060416467,
0.281152458069904,
0.282089349035079,
0.283026735478514,
0.283964619573656,
0.284903003500919,
0.285841889447725,
0.286781279608551,
0.287721176184971,
0.288661581385703,
0.289602497426651,
0.290543926530951,
0.291485870929018,
0.292428332858587,
0.293371314564766,
0.294314818300075,
0.295258846324497,
0.296203400905524,
0.297148484318203,
0.298094098845185,
0.299040246776770,
0.299986930410960,
0.300934152053502,
0.301881914017941,
0.302830218625666,
0.303779068205960,
0.304728465096054,
0.305678411641169,
0.306628910194575,
0.307579963117633,
0.308531572779855,
0.309483741558950,
0.310436471840876,
0.311389766019894,
0.312343626498620,
0.313298055688075,
0.314253056007745,
0.315208629885628,
0.316164779758290,
0.317121508070921,
0.318078817277387,
0.319036709840289,
0.319995188231013,
0.320954254929792,
0.321913912425757,
0.322874163216997,
0.323835009810615,
0.324796454722784,
0.325758500478809,
0.326721149613182,
0.327684404669639,
0.328648268201224,
0.329612742770345,
0.330577830948835,
0.331543535318013,
0.332509858468744,
0.333476803001499,
0.334444371526422,
0.335412566663383,
0.336381391042051,
0.337350847301949,
0.338320938092522,
0.339291666073198,
0.340263033913455,
0.341235044292885,
0.342207699901259,
0.343181003438593,
0.344154957615214,
0.345129565151828,
0.346104828779585,
0.347080751240152,
0.348057335285774,
0.349034583679349,
0.350012499194493,
0.350991084615612,
0.351970342737974,
0.352950276367777,
0.353930888322220,
0.354912181429579,
0.355894158529276,
0.356876822471951,
0.357860176119540,
0.358844222345347,
0.359828964034117,
0.360814404082112,
0.361800545397190,
0.362787390898879,
0.363774943518451,
0.364763206199005,
0.365752181895545,
0.366741873575051,
0.367732284216570,
0.368723416811286,
0.369715274362607,
0.370707859886243,
0.371701176410289,
0.372695226975308,
0.373690014634413,
0.374685542453351,
0.375681813510588,
0.376678830897397,
0.377676597717935,
0.378675117089340,
0.379674392141812,
0.380674426018701,
0.381675221876599,
0.382676782885425,
0.383679112228518,
0.384682213102725,
0.385686088718496,
0.386690742299974,
0.387696177085086,
0.388702396325639,
0.389709403287415,
0.390717201250264,
0.391725793508200,
0.392735183369500,
0.393745374156798,
0.394756369207185,
0.395768171872309,
0.396780785518473,
0.397794213526737,
0.398808459293017,
0.399823526228190,
0.400839417758196,
0.401856137324143,
0.402873688382408,
0.403892074404747,
0.404911298878401,
0.405931365306201,
0.406952277206677,
0.407974038114169,
0.408996651578935,
0.410020121167263,
0.411044450461584,
0.412069643060583,
0.413095702579312,
0.414122632649308,
0.415150436918707,
0.416179119052360,
0.417208682731953,
0.418239131656121,
0.419270469540574,
0.420302700118213,
0.421335827139254,
0.422369854371349,
0.423404785599714,
0.424440624627246,
0.425477375274657,
0.426515041380597,
0.427553626801785,
0.428593135413133,
0.429633571107880,
0.430674937797726,
0.431717239412959,
0.432760479902592,
0.433804663234498,
0.434849793395545,
0.435895874391734,
0.436942910248338,
0.437990905010041,
0.439039862741078,
0.440089787525380,
0.441140683466714,
0.442192554688831,
0.443245405335609,
0.444299239571204,
0.445354061580194,
0.446409875567734,
0.447466685759702,
0.448524496402856,
0.449583311764987,
0.450643136135071,
0.451703973823432,
0.452765829161893,
0.453828706503943,
0.454892610224893,
0.455957544722039,
0.457023514414828,
0.458090523745023,
0.459158577176868,
0.460227679197261,
0.461297834315919,
0.462369047065552,
0.463441322002038,
0.464514663704593,
0.465589076775954,
0.466664565842551,
0.467741135554691,
0.468818790586737,
0.469897535637292,
0.470977375429384,
0.472058314710653,
0.473140358253536,
0.474223510855463,
0.475307777339044,
0.476393162552263,
0.477479671368678,
0.478567308687612,
0.479656079434357,
0.480745988560373,
0.481837041043491,
0.482929241888119,
0.484022596125449,
0.485117108813664,
0.486212785038151,
0.487309629911714,
0.488407648574787,
0.489506846195652,
0.490607227970662,
0.491708799124454,
0.492811564910181,
0.493915530609733,
0.495020701533965,
0.496127083022930,
0.497234680446107,
0.498343499202641,
0.499453544721574,
0.500564822462089,
0.501677337913749,
0.502791096596745,
0.503906104062135,
0.505022365892100,
0.506139887700193,
0.507258675131593,
0.508378733863359,
0.509500069604695,
0.510622688097205,
0.511746595115163,
0.512871796465774,
0.513998297989450,
0.515126105560079,
0.516255225085298,
0.517385662506778,
0.518517423800497,
0.519650514977029,
0.520784942081828,
0.521920711195519,
0.523057828434190,
0.524196299949687,
0.525336131929913,
0.526477330599132,
0.527619902218269,
0.528763853085223,
0.529909189535176,
0.531055917940906,
0.532204044713109,
0.533353576300717,
0.534504519191222,
0.535656879911007,
0.536810665025675,
0.537965881140385,
0.539122534900189,
0.540280632990377,
0.541440182136822,
0.542601189106326,
0.543763660706979,
0.544927603788511,
0.546093025242656,
0.547259932003515,
0.548428331047925,
0.549598229395834,
0.550769634110676,
0.551942552299750,
0.553116991114609,
0.554292957751446,
0.555470459451489,
0.556649503501400,
0.557830097233675,
0.559012248027051,
0.560195963306921,
0.561381250545743,
0.562568117263467,
0.563756571027956,
0.564946619455418,
0.566138270210839,
0.567331531008424,
0.568526409612041,
0.569722913835671,
0.570921051543860,
0.572120830652184,
0.573322259127709,
0.574525344989462,
0.575730096308912,
0.576936521210442,
0.578144627871844,
0.579354424524807,
0.580565919455416,
0.581779121004654,
0.582994037568916,
0.584210677600517,
0.585429049608222,
0.586649162157767,
0.587871023872396,
0.589094643433400,
0.590320029580661,
0.591547191113211,
0.592776136889783,
0.594006875829384,
0.595239416911865,
0.596473769178497,
0.597709941732564,
0.598947943739951,
0.600187784429746,
0.601429473094849,
0.602673019092587,
0.603918431845332,
0.605165720841137,
0.606414895634372,
0.607665965846365,
0.608918941166062,
0.610173831350684,
0.611430646226396,
0.612689395688988,
0.613950089704557,
0.615212738310206,
0.616477351614741,
0.617743939799390,
0.619012513118516,
0.620283081900355,
0.621555656547745,
0.622830247538884,
0.624106865428081,
0.625385520846526,
0.626666224503063,
0.627948987184983,
0.629233819758815,
0.630520733171133,
0.631809738449380,
0.633100846702684,
0.634394069122708,
0.635689416984490,
0.636986901647309,
0.638286534555552,
0.639588327239600,
0.640892291316719,
0.642198438491966,
0.643506780559110,
0.644817329401556,
0.646130096993291,
0.647445095399838,
0.648762336779220,
0.650081833382942,
0.651403597556984,
0.652727641742806,
0.654053978478367,
0.655382620399160,
0.656713580239258,
0.658046870832375,
0.659382505112942,
0.660720496117198,
0.662060856984292,
0.663403600957407,
0.664748741384896,
0.666096291721426,
0.667446265529154,
0.668798676478904,
0.670153538351369,
0.671510865038327,
0.672870670543873,
0.674232968985669,
0.675597774596214,
0.676965101724128,
0.678334964835456,
0.679707378514989,
0.681082357467607,
0.682459916519639,
0.683840070620238,
0.685222834842787,
0.686608224386313,
0.687996254576927,
0.689386940869289,
0.690780298848081,
0.692176344229520,
0.693575092862873,
0.694976560732013,
0.696380763956981,
0.697787718795585,
0.699197441645014,
0.700609949043477,
0.702025257671867,
0.703443384355455,
0.704864346065599,
0.706288159921489,
0.707714843191907,
0.709144413297026,
0.710576887810228,
0.712012284459949,
0.713450621131559,
0.714891915869261,
0.716336186878028,
0.717783452525567,
0.719233731344307,
0.720687042033428,
0.722143403460915,
0.723602834665641,
0.725065354859495,
0.726530983429527,
0.727999739940140,
0.729471644135307,
0.730946715940830,
0.732424975466633,
0.733906443009085,
0.735391139053373,
0.736879084275898,
0.738370299546721,
0.739864805932045,
0.741362624696733,
0.742863777306873,
0.744368285432381,
0.745876170949646,
0.747387455944222,
0.748902162713561,
0.750420313769793,
0.751941931842547,
0.753467039881828,
0.754995661060935,
0.756527818779427,
0.758063536666146,
0.759602838582281,
0.761145748624492,
0.762692291128086,
0.764242490670239,
0.765796372073282,
0.767353960408043,
0.768915280997238,
0.770480359418931,
0.772049221510045,
0.773621893369941,
0.775198401364056,
0.776778772127602,
0.778363032569337,
0.779951209875396,
0.781543331513194,
0.783139425235393,
0.784739519083947,
0.786343641394216,
0.787951820799149,
0.789564086233550,
0.791180466938416,
0.792800992465360,
0.794425692681104,
0.796054597772064,
0.797687738249016,
0.799325144951845,
0.800966849054388,
0.802612882069357,
0.804263275853368,
0.805918062612050,
0.807577274905259,
0.809240945652387,
0.810909108137771,
0.812581796016206,
0.814259043318562,
0.815940884457514,
0.817627354233369,
0.819318487840023,
0.821014320871017,
0.822714889325726,
0.824420229615654,
0.826130378570861,
0.827845373446522,
0.829565251929600,
0.831290052145667,
0.833019812665850,
0.834754572513925,
0.836494371173545,
0.838239248595618,
0.839989245205839,
0.841744401912368,
0.843504760113665,
0.845270361706494,
0.847041249094084,
0.848817465194460,
0.850599053448951,
0.852386057830873,
0.854178522854392,
0.855976493583579,
0.857780015641653,
0.859589135220419,
0.861403899089911,
0.863224354608239,
0.865050549731648,
0.866882533024798,
0.868720353671263,
0.870564061484256,
0.872413706917603,
0.874269341076939,
0.876131015731169,
0.877998783324173,
0.879872696986774,
0.881752810548978,
0.883639178552486,
0.885531856263490,
0.887430899685762,
0.889336365574036,
0.891248311447704,
0.893166795604827,
0.895091877136461,
0.897023615941330,
0.898962072740832,
0.900907309094407,
0.902859387415253,
0.904818370986431,
0.906784323977346,
0.908757311460622,
0.910737399429385,
0.912724654814966,
0.914719145505033,
0.916720940362164,
0.918730109242880,
0.920746723017144,
0.922770853588349,
0.924802573913799,
0.926841958025707,
0.928889081052717,
0.930944019241984,
0.933006849981796,
0.935077651824797,
0.937156504511787,
0.939243488996156,
0.941338687468939,
0.943442183384533,
0.945554061487092,
0.947674407837612,
0.949803309841744,
0.951940856278343,
0.954087137328789,
0.956242244607100,
0.958406271190856,
0.960579311652979,
0.962761462094376,
0.964952820177489,
0.967153485160779,
0.969363557934165,
0.971583141055468,
0.973812338787883,
0.976051257138512,
0.978300003898005,
0.980558688681335,
0.982827422969764,
0.985106320154012,
0.987395495578712,
0.989695066588159,
0.992005152573419,
0.994325875020852,
0.996657357562073,
0.998999726025439,
1.001353108489093,
1.003717635335624,
1.006093439308422,
1.008480655569764,
1.010879421760720,
1.013289878062929,
1.015712167262334,
1.018146434814935,
1.020592828914643,
1.023051500563326,
1.025522603643117,
1.028006294991084,
1.030502734476348,
1.033012085079757,
1.035534512976208,
1.038070187619724,
1.040619281831409,
1.043181971890389,
1.045758437627861,
1.048348862524390,
1.050953433810574,
1.053572342571238,
1.056205783853286,
1.058853956777385,
1.061517064653632,
1.064195315101392,
1.066888920173469,
1.069598096484823,
1.072323065346017,
1.075064052901614,
1.077821290273742,
1.080595013711072,
1.083385464743438,
1.086192890342378,
1.089017543087860,
1.091859681341482,
1.094719569426461,
1.097597477814722,
1.100493683321435,
1.103408469307357,
1.106342125889364,
1.109294950159567,
1.112267246413449,
1.115259326387458,
1.118271509506555,
1.121304123142199,
1.124357502881320,
1.127431992806848,
1.130527945790397,
1.133645723797736,
1.136785698207748,
1.139948250145584,
1.143133770830779,
1.146342661941160,
1.149575335993404,
1.152832216741186,
1.156113739591886,
1.159420352042932,
1.162752514138882,
1.166110698950461,
1.169495393076825,
1.172907097172426,
1.176346326499950,
1.179813611510885,
1.183309498455419,
1.186834550023444,
1.190389346018633,
1.193974484067630,
1.197590580366610,
1.201238270467595,
1.204918210107094,
1.208631076079868,
1.212377567160785,
1.216158405078015,
1.219974335541021,
1.223826129327141,
1.227714583430797,
1.231640522279750,
1.235604799023170,
1.239608296896687,
1.243651930670018,
1.247736648183305,
1.251863431978741,
1.256033301034743,
1.260247312610499,
1.264506564209489,
1.268812195671333,
1.273165391402202,
1.277567382755017,
1.282019450571696,
1.286522927900949,
1.291079202906413,
1.295689721981426,
1.300355993088383,
1.305079589342464,
1.309862152861612,
1.314705398906942,
1.319611120340379,
1.324581192429286,
1.329617578031105,
1.334722333194842,
1.339897613220402,
1.345145679221634,
1.350468905244371,
1.355869785996995,
1.361350945258137,
1.366915145034233,
1.372565295549000,
1.378304466157532,
1.384135897290106,
1.390063013544959,
1.396089438065835,
1.402219008359217,
1.408455793728477,
1.414804114528242,
1.421268563472795,
1.427854029268285,
1.434565722880840,
1.441409206802883,
1.448390427739580,
1.455515753208438,
1.462792012630323,
1.470226543592630,
1.477827244089202,
1.485602631691902,
1.493561910792157,
1.501715049275634,
1.510072866270414,
1.518647132952758,
1.527450688823261,
1.536497576404452,
1.545803197991110,
1.555384498950601,
1.565260183181398,
1.575450967774565,
1.585979885797304,
1.596872648585554,
1.608158082215050,
1.619868657233051,
1.632041136734632,
1.644717376133346,
1.657945319516554,
1.671780253829480,
1.686286405686444,
1.701539000145284,
1.717626952433047,
1.734656442571280,
1.752755746550221,
1.772081896911936,
1.792830076606208,
1.815247220008462,
1.839652318114830,
1.866467852510270,
1.896270629694986,
1.929878520018855,
1.968508816590769,
2.014094010173103,
2.069992166161024,
2.142894588876736,
2.249702374086000,
2.465754958722744
};

const double inverse_cdf(double x) {
  if (x<0.5) return -inverse_cdf(1-x);
  const size_t f = floor(2048*(x-0.5)); // TODO interpolation
  return sqrt(2)*inverse_cdf_lut[f];
}

const double cdf(const double x) {
  return 0.5*(1+erf(x/sqrt(2)));
}

int main() {
  size_t n = 256;
  std::random_device rd;
  std::uniform_real_distribution<double> ud(0.0,1.0);
  std::normal_distribution<double> nd;
  vector<tuple<double,double,double>> samples(n);
  for (size_t i=0;i!=n;++i) {
    get<0>(samples[i]) = ud(rd)-ud(rd)
                        +ud(rd)-ud(rd)
                        +ud(rd)-ud(rd);
    get<1>(samples[i]) = ud(rd)-ud(rd)
                        +ud(rd)-ud(rd)
                        +ud(rd)-ud(rd);
    get<2>(samples[i]) = ud(rd)-ud(rd)
                        +ud(rd)-ud(rd)
                        +ud(rd)-ud(rd);
  }
  for (size_t i=0;i!=16384;++i) {
    double q0 = nd(rd);
    double q1 = nd(rd);
    double q2 = nd(rd);
    double q3 = nd(rd);
    const double c = 1.0/sqrt(pow(q0,2)+pow(q1,2)+pow(q2,2)+pow(q3,2));
    q0*=c;
    q1*=c;
    q2*=c;
    q3*=c;
    matrix<double,3,3> R
    {
      q0*q0+q1*q1-q2*q2-q3*q3,         2*(q1*q2-q0*q3),         2*(q1*q3+q0*q2),
              2*(q1*q2+q0*q3), q0*q0-q1*q1+q2*q2-q3*q3,         2*(q2*q3-q0*q1),
              2*(q1*q3-q0*q2),         2*(q2*q3+q0*q1), q0*q0-q1*q1-q2*q2+q3*q3
    };
    for (size_t i=0;i!=n;++i) {
      matrix<double,3,1> x{get<0>(samples[i]),
                           get<1>(samples[i]),
                           get<2>(samples[i])};
      x = R*x;
      get<0>(samples[i])=x(0);
      get<1>(samples[i])=x(1);
      get<2>(samples[i])=x(2);
    }
    sort(samples.begin(),samples.end());
    for (size_t i=0;i!=samples.size();++i) {
      get<0>(samples[i])+=(1.0/1024)*(inverse_cdf((i+0.5)/samples.size())
                                     -get<0>(samples[i]));
      //get<0>(samples[i])=inverse_cdf((i+0.5)/samples.size());
    }
  }
  for (auto it=samples.begin();it!=samples.end();++it) {
    cout << get<0>(*it) << " "
         << get<1>(*it) << " "
         << get<2>(*it) << endl;
  }
}
